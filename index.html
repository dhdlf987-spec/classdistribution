<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ìŠ¤ë§ˆíŠ¸ ë°˜ë°°ì¹˜ ì‹œìŠ¤í…œ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Malgun Gothic', sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      text-align: center;
    }

    h1 {
      color: #333;
      font-size: 32px;
      margin-bottom: 10px;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .settings-page {
      max-width: 700px;
      margin: 0 auto;
    }

    .settings-box {
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .info-box {
      background: #f0f8ff;
      border-left: 4px solid #2196F3;
      padding: 20px;
      margin-bottom: 30px;
      border-radius: 8px;
    }

    .info-box h3 {
      color: #1976D2;
      margin-bottom: 15px;
    }

    .info-box ul {
      line-height: 2;
      color: #333;
      margin-left: 20px;
    }

    .legend-box {
      background: #fff3e0;
      border-left: 4px solid #FF9800;
      padding: 15px;
      margin-bottom: 30px;
      border-radius: 8px;
    }

    .legend-box h3 {
      color: #F57C00;
      margin-bottom: 10px;
    }

    .legend-items {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 14px;
    }

    .legend-item {
      background: white;
      padding: 5px 10px;
      border-radius: 5px;
    }

    .form-group {
      margin-bottom: 25px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: bold;
      font-size: 15px;
    }

    input, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 15px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #333;
    }

    button {
      width: 100%;
      padding: 15px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #333;
      color: white;
    }

    .btn-primary:hover {
      background: #555;
    }

    .upload-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .upload-box {
      border: 3px dashed #ccc;
      border-radius: 10px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: white;
      position: relative;
    }

    .upload-box:hover {
      border-color: #333;
      background: #f9f9f9;
    }

    .upload-box.uploaded {
      border-color: #4CAF50;
      background: #e8f5e9;
    }

    .upload-box.dragover {
      border-color: #333;
      background: #e8e8e8;
      transform: scale(1.02);
    }

    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .class-section {
      background: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .class-main-header {
      background: #333;
      color: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      font-size: 18px;
      margin-bottom: 10px;
    }

    .class-stats {
      background: #f9f9f9;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 15px;
      font-size: 12px;
      color: #666;
    }

    .class-columns {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .class-column {
      background: #f9f9f9;
      border-radius: 8px;
      padding: 10px;
      min-height: 300px;
    }

    .class-sub-header {
      background: #666;
      color: white;
      padding: 8px;
      border-radius: 5px;
      text-align: center;
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .student-card {
      background: white;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 6px;
      cursor: move;
      border: 2px solid transparent;
      transition: all 0.2s;
      text-align: center;
      position: relative;
    }

    .student-card:hover {
      border-color: #333;
      transform: scale(1.02);
    }

    .student-card.female {
      background: #FFE4E1;
    }

    .student-card.male {
      background: #E0F2FF;
    }

    .student-card.dragging {
      opacity: 0.5;
    }

    .delete-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }

    .student-card:hover .delete-btn {
      display: flex;
    }

    .action-bar {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .action-bar button {
      flex: 1;
    }

    .btn-success {
      background: #4CAF50;
      color: white;
    }

    .btn-success:hover {
      background: #45a049;
    }

    .btn-danger {
      background: #f44336;
      color: white;
    }

    .btn-danger:hover {
      background: #da190b;
    }

    .message {
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      text-align: center;
      font-weight: bold;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ« ìŠ¤ë§ˆíŠ¸ ë°˜ë°°ì¹˜ ì‹œìŠ¤í…œ</h1>
      <p style="color: #666; margin-top: 10px;">íŠ¹ìˆ˜ìƒí™© í•™ìƒ ê· ë“± ë°°ì¹˜ + ì „í•™ ì˜ˆì • í•™ìƒ ìë™ ë¶„ì‚°</p>
    </header>

    <!-- í˜ì´ì§€ 1: ì„¤ì • -->
    <div class="page active" id="page1">
      <div class="settings-page">
        <div class="settings-box">
          <h2 style="margin-bottom: 20px;">âš™ï¸ ì´ˆê¸° ì„¤ì •</h2>
          
          <div class="info-box">
            <h3>ğŸ“‹ ì‚¬ìš© ë°©ë²•</h3>
            <ul>
              <li><strong>ë™í•™ë…„ ëŒ€í‘œ ì„ ìƒë‹˜</strong>ì´ ê° ë°˜ì˜ ì„±ì ìˆœ ëª…ë ¬í‘œ PDFë¥¼ ëª¨ë‘ ë°›ìŠµë‹ˆë‹¤</li>
              <li>1ë°˜ë¶€í„° ìˆœì„œëŒ€ë¡œ PDF íŒŒì¼ì„ ì—…ë¡œë“œí•©ë‹ˆë‹¤</li>
              <li><strong>ê¸°ë³¸ ë°°ì¹˜ ì›ë¦¬:</strong> 1ë°˜ ì—¬í•™ìƒ 1ë“±â†’ê°€ë°˜, 2ë“±â†’ë‚˜ë°˜, 3ë“±â†’ë‹¤ë°˜... / ë‚¨í•™ìƒ 1ë“±â†’ë¼ë°˜, 2ë“±â†’ë§ˆë°˜, 3ë“±â†’ë°”ë°˜...</li>
              <li><strong>2ë°˜:</strong> ì—¬í•™ìƒ 1ë“±â†’ë‚˜ë°˜, ë‚¨í•™ìƒ 1ë“±â†’ë§ˆë°˜ë¶€í„° ì‹œì‘ (ê· ë“± ë¶„ì‚°)</li>
              <li><strong>íŠ¹ìˆ˜ìƒí™© í•™ìƒ</strong>(ìƒí™œì§€ë„/íŠ¹ìˆ˜/í•™ìŠµë¶€ì§„/ë‹¤ë¬¸í™”)ì„ ìë™ìœ¼ë¡œ ê³¨ê³ ë£¨ ë¶„ì‚° ë°°ì¹˜í•©ë‹ˆë‹¤</li>
              <li><strong>ì „í•™ ì˜ˆì • í•™ìƒ</strong>ì€ ë§ˆì§€ë§‰ì— ê· ë“±í•˜ê²Œ ë°°ì¹˜í•©ë‹ˆë‹¤</li>
              <li>ê²°ê³¼ í™•ì¸ í›„ í•„ìš”ì‹œ ë“œë˜ê·¸ë¡œ ì¡°ì •í•˜ê³  ì—‘ì…€ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤</li>
              <li>ğŸ’¾ ë°ì´í„°ëŠ” ì´ ì»´í“¨í„° ë¸Œë¼ìš°ì €ì— ìë™ ì €ì¥ë©ë‹ˆë‹¤ (ìƒˆë¡œê³ ì¹¨í•´ë„ ì•ˆì „)</li>
            </ul>
          </div>

          <div class="legend-box">
            <h3>ğŸ¨ í‘œì‹œ ê¸°í˜¸ (ì¤‘ë³µ ê°€ëŠ¥)</h3>
            <div class="legend-items">
              <span class="legend-item">â­ ìƒí™œì§€ë„</span>
              <span class="legend-item"># íŠ¹ìˆ˜</span>
              <span class="legend-item">â— í•™ìŠµë¶€ì§„/ê¸°ì´ˆí•™ë ¥</span>
              <span class="legend-item">@ ë‹¤ë¬¸í™”</span>
              <span class="legend-item">ğŸ”„ ì „ì¶œì˜ˆì •</span>
              <span class="legend-item" style="background: #FFE4E1;">ì—¬í•™ìƒ</span>
              <span class="legend-item" style="background: #E0F2FF;">ë‚¨í•™ìƒ</span>
            </div>
            <p style="margin-top: 10px; font-size: 13px; color: #666;">
              ì˜ˆ: @â—ê¹€ìˆ˜ì§€ (ë‹¤ë¬¸í™” + í•™ìŠµë¶€ì§„) / ğŸ”„ì´ë¯¼í˜¸ (ì „ì¶œì˜ˆì •)
            </p>
          </div>
          
          <div class="form-group">
            <label>í•™êµëª…</label>
            <input type="text" id="schoolName" placeholder="ì˜ˆ: ì„œìš¸ì´ˆë“±í•™êµ">
          </div>
          
          <div class="form-group">
            <label>í˜„ì¬ í•™ë…„</label>
            <input type="number" id="grade" placeholder="ì˜ˆ: 5" min="1" max="6">
          </div>
          
          <div class="form-group">
            <label>í˜„ì¬ ì´ ë°˜ ìˆ˜ (ì—…ë¡œë“œí•  ë°˜ ìˆ˜)</label>
            <select id="currentClasses">
              <option value="3">3ê°œ ë°˜</option>
              <option value="4">4ê°œ ë°˜</option>
              <option value="5">5ê°œ ë°˜</option>
              <option value="6" selected>6ê°œ ë°˜</option>
              <option value="7">7ê°œ ë°˜</option>
              <option value="8">8ê°œ ë°˜</option>
              <option value="9">9ê°œ ë°˜</option>
              <option value="10">10ê°œ ë°˜</option>
            </select>
          </div>

          <div class="form-group">
            <label>ë°°ì •í•  ì´ ë°˜ ìˆ˜ (ë‚´ë…„ë„ ë°˜ ìˆ˜)</label>
            <select id="totalClasses">
              <option value="3">3ê°œ ë°˜</option>
              <option value="4">4ê°œ ë°˜</option>
              <option value="5">5ê°œ ë°˜</option>
              <option value="6" selected>6ê°œ ë°˜</option>
              <option value="7">7ê°œ ë°˜</option>
              <option value="8">8ê°œ ë°˜</option>
              <option value="9">9ê°œ ë°˜</option>
              <option value="10">10ê°œ ë°˜</option>
            </select>
          </div>
          
          <button class="btn-primary" onclick="saveSettings()">ì„¤ì • ì €ì¥ ë° ì‹œì‘í•˜ê¸°</button>
          
          <div id="settingsMessage"></div>
        </div>
      </div>
    </div>

    <!-- í˜ì´ì§€ 2: ì—…ë¡œë“œ -->
    <div class="page" id="page2">
      <div style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <h2 style="margin-bottom: 20px;">ğŸ“¤ ëª…ë ¬í‘œ ì—…ë¡œë“œ</h2>
        
        <div class="legend-box">
          <h3>ğŸ¨ í‘œì‹œ ê¸°í˜¸</h3>
          <div class="legend-items">
            <span class="legend-item">â­ ìƒí™œì§€ë„</span>
            <span class="legend-item"># íŠ¹ìˆ˜</span>
            <span class="legend-item">â— í•™ìŠµë¶€ì§„</span>
            <span class="legend-item">@ ë‹¤ë¬¸í™”</span>
            <span class="legend-item">ğŸ”„ ì „í•™ì˜ˆì •</span>
          </div>
        </div>

        <div class="upload-grid" id="uploadGrid"></div>

        <div class="action-bar">
          <button class="btn-success" onclick="showPage(3)">ë°°ì¹˜ ê²°ê³¼ í™•ì¸í•˜ê¸° â†’</button>
        </div>

        <div id="uploadMessage"></div>
      </div>
    </div>

    <!-- í˜ì´ì§€ 3: ê²°ê³¼ -->
    <div class="page" id="page3">
      <div style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <h2 style="margin-bottom: 10px;">ğŸ“Š ë°˜ë°°ì¹˜ ê²°ê³¼</h2>
        <p style="color: #666; margin-bottom: 20px;">ë“œë˜ê·¸ ì•¤ ë“œë¡­ìœ¼ë¡œ í•™ìƒì„ ë‹¤ë¥¸ ë°˜ìœ¼ë¡œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>

        <div class="legend-box">
          <h3>ğŸ¨ í‘œì‹œ ê¸°í˜¸</h3>
          <div class="legend-items">
            <span class="legend-item">â­ ìƒí™œì§€ë„</span>
            <span class="legend-item"># íŠ¹ìˆ˜</span>
            <span class="legend-item">â— í•™ìŠµë¶€ì§„</span>
            <span class="legend-item">@ ë‹¤ë¬¸í™”</span>
            <span class="legend-item">ğŸ”„ ì „í•™ì˜ˆì •</span>
          </div>
        </div>

        <div class="result-grid" id="resultGrid"></div>

        <div class="action-bar">
          <button class="btn-primary" onclick="showPage(2)">â† ì—…ë¡œë“œ í˜ì´ì§€ë¡œ</button>
          <button class="btn-success" onclick="downloadExcel()">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
          <button class="btn-danger" onclick="resetAll()">ğŸ”„ ì „ì²´ ì´ˆê¸°í™”</button>
        </div>

        <div id="resultMessage"></div>
      </div>
    </div>
  </div>

  <script>
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    }

    let settings = {
      schoolName: '',
      grade: '',
      currentClasses: 6,
      totalClasses: 6
    };

    let distributedStudents = {};
    let uploadedClasses = {};
    let draggedStudent = null;
    let draggedFrom = null;

    const classNames = ['ê°€ë°˜', 'ë‚˜ë°˜', 'ë‹¤ë°˜', 'ë¼ë°˜', 'ë§ˆë°˜', 'ë°”ë°˜', 'ì‚¬ë°˜', 'ì•„ë°˜', 'ìë°˜', 'ì°¨ë°˜'];

    window.addEventListener('load', loadAutoSave);

    function autoSave() {
      const data = {
        settings,
        distributedStudents,
        uploadedClasses,
        timestamp: new Date().toISOString()
      };
      localStorage.setItem('classDistribution_autoSave', JSON.stringify(data));
    }

    function loadAutoSave() {
      const saved = localStorage.getItem('classDistribution_autoSave');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          if (confirm('ìë™ ì €ì¥ëœ ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤. ì´ì–´ì„œ ì‘ì—…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            settings = data.settings;
            distributedStudents = data.distributedStudents;
            uploadedClasses = data.uploadedClasses || {};
            
            document.getElementById('schoolName').value = settings.schoolName;
            document.getElementById('grade').value = settings.grade;
            document.getElementById('currentClasses').value = settings.currentClasses;
            document.getElementById('totalClasses').value = settings.totalClasses;
            
            if (settings.schoolName && settings.grade) {
              showPage(2);
            }
          }
        } catch (error) {
          console.error('ìë™ ì €ì¥ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        }
      }
    }

    function clearAutoSave() {
      localStorage.removeItem('classDistribution_autoSave');
    }

    function showPage(pageNum) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page' + pageNum).classList.add('active');

      if (pageNum === 2) {
        initUploadGrid();
      } else if (pageNum === 3) {
        renderResult();
      }
    }

    function saveSettings() {
      settings.schoolName = document.getElementById('schoolName').value;
      settings.grade = document.getElementById('grade').value;
      settings.currentClasses = parseInt(document.getElementById('currentClasses').value);
      settings.totalClasses = parseInt(document.getElementById('totalClasses').value);

      if (!settings.schoolName || !settings.grade) {
        showMessage('settingsMessage', 'ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'error');
        return;
      }

      distributedStudents = {};
      uploadedClasses = {};
      for (let i = 0; i < settings.totalClasses; i++) {
        distributedStudents[classNames[i] + '(ì—¬)'] = [];
        distributedStudents[classNames[i] + '(ë‚¨)'] = [];
      }

      autoSave();
      showMessage('settingsMessage', 'ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
      setTimeout(() => showPage(2), 1000);
    }

    function initUploadGrid() {
      const grid = document.getElementById('uploadGrid');
      grid.innerHTML = '';

      for (let i = 1; i <= settings.currentClasses; i++) {
        const box = document.createElement('div');
        box.className = 'upload-box';
        if (uploadedClasses[i]) box.classList.add('uploaded');
        box.id = 'upload-box-' + i;
        
        if (uploadedClasses[i]) {
          box.innerHTML = `
            <div style="font-size: 48px; margin-bottom: 10px;">âœ…</div>
            <div style="font-weight: bold; font-size: 18px; margin-bottom: 10px;">${i}ë°˜ ì™„ë£Œ</div>
            <div style="color: #2e7d32; font-size: 14px; margin-bottom: 10px;">ì—¬: ${uploadedClasses[i].female}ëª… / ë‚¨: ${uploadedClasses[i].male}ëª…</div>
            <button onclick="reuploadClass(${i}); event.stopPropagation();" style="background: #FF9800; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">ë‹¤ì‹œ ì—…ë¡œë“œ</button>
          `;
        } else {
          box.innerHTML = `
            <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“„</div>
            <div style="font-weight: bold; font-size: 18px; margin-bottom: 10px;">${i}ë°˜</div>
            <div style="color: #666; font-size: 14px;">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
            <input type="file" accept=".pdf,.txt" style="display: none;" id="file-input-${i}">
          `;
        }
        
        const input = box.querySelector('input');
        if (input) {
          box.onclick = function(e) {
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') {
              input.click();
            }
          };
          
          input.onchange = function(e) {
            handleFileUpload(e, i);
          };
          
          box.ondragover = function(e) {
            e.preventDefault();
            e.stopPropagation();
            box.classList.add('dragover');
          };
          
          box.ondragleave = function(e) {
            e.preventDefault();
            e.stopPropagation();
            box.classList.remove('dragover');
          };
          
          box.ondrop = function(e) {
            e.preventDefault();
            e.stopPropagation();
            box.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
              const fakeEvent = { target: { files: [files[0]] } };
              handleFileUpload(fakeEvent, i);
            }
          };
        }
        
        grid.appendChild(box);
      }
    }

    function reuploadClass(classNumber) {
      for (let key in distributedStudents) {
        distributedStudents[key] = distributedStudents[key].filter(s => s.originalClass !== classNumber);
      }
      
      delete uploadedClasses[classNumber];
      
      autoSave();
      initUploadGrid();
      showMessage('uploadMessage', `${classNumber}ë°˜ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.`, 'success');
    }

    async function handleFileUpload(event, classNumber) {
      const file = event.target.files[0];
      if (!file) return;

      const box = document.getElementById('upload-box-' + classNumber);
      box.innerHTML = '<div style="padding: 20px;">â³ ì²˜ë¦¬ ì¤‘...</div>';

      try {
        let text = '';
        
        if (file.type === 'application/pdf' || file.name.endsWith('.pdf')) {
          try {
            text = await extractPDFText(file);
          } catch (pdfError) {
            console.log('PDF íŒŒì‹± ì‹¤íŒ¨, í…ìŠ¤íŠ¸ë¡œ ì‹œë„:', pdfError);
            text = await file.text();
          }
        } else {
          text = await file.text();
        }

        const students = parseStudentData(text);
        distributeStudentsWithBalance(students, classNumber);

        uploadedClasses[classNumber] = {
          female: students.female.length,
          male: students.male.length
        };

        box.classList.add('uploaded');
        box.innerHTML = `
          <div style="font-size: 48px; margin-bottom: 10px;">âœ…</div>
          <div style="font-weight: bold; font-size: 18px; margin-bottom: 10px;">${classNumber}ë°˜ ì™„ë£Œ</div>
          <div style="color: #2e7d32; font-size: 14px; margin-bottom: 10px;">ì—¬: ${students.female.length}ëª… / ë‚¨: ${students.male.length}ëª…</div>
          <button onclick="reuploadClass(${classNumber}); event.stopPropagation();" style="background: #FF9800; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">ë‹¤ì‹œ ì—…ë¡œë“œ</button>
        `;
        
        autoSave();
        showMessage('uploadMessage', `${classNumber}ë°˜ í•™ìƒ ë°°ì¹˜ ì™„ë£Œ!`, 'success');
      } catch (error) {
        box.classList.remove('uploaded');
        initUploadGrid();
        showMessage('uploadMessage', `íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ${error.message}`, 'error');
        console.error('íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
      }
    }

    async function extractPDFText(file) {
      try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ 
          data: arrayBuffer,
          verbosity: 0
        }).promise;
        let fullText = '';

        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();
          const pageText = textContent.items.map(item => item.str).join(' ');
          fullText += pageText + '\n';
        }

        return fullText;
      } catch (error) {
        console.error('PDF íŒŒì‹± ì˜¤ë¥˜:', error);
        throw new Error('PDF íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ë³€í™˜ í›„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
      }
    }

    function parseStudentData(text) {
      const lines = text.split('\n');
      const female = [];
      const male = [];

      for (let line of lines) {
        const parts = line.trim().split(/\s+/);

        for (let i = 0; i < parts.length; i++) {
          if (parts[i] === 'ì—¬' && parts[i + 1]) {
            let name = parts[i + 1];
            
            // ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë¦„ í•„í„°ë§
            if (isValidName(name)) {
              let notes = [];
              
              for (let j = i + 2; j < i + 7 && j < parts.length; j++) {
                if (parts[j] === 'ë‚¨' || parts[j] === 'ì—¬') break;
                if (parts[j] && !parts[j].match(/^\d+$/)) {
                  const note = parts[j].toLowerCase();
                  // ìœ ì—°í•œ í‚¤ì›Œë“œ ë§¤ì¹­
                  if (note.includes('ìƒí™œ') || note.includes('ì§€ë„')) {
                    notes.push('ìƒí™œì§€ë„');
                  } else if (note.includes('íŠ¹ìˆ˜') || note.includes('ì¥ì• ')) {
                    notes.push('íŠ¹ìˆ˜');
                  } else if (note.includes('í•™ìŠµ') || note.includes('ê¸°ì´ˆ') || note.includes('í•™ë ¥')) {
                    notes.push('í•™ìŠµë¶€ì§„');
                  } else if (note.includes('ë‹¤ë¬¸í™”')) {
                    notes.push('ë‹¤ë¬¸í™”');
                  } else if (note.includes('ì „í•™') || note.includes('ì „ì¶œ')) {
                    notes.push('ì „ì¶œì˜ˆì •');
                  }
                }
              }

              // ì¤‘ë³µ ì œê±°
              notes = [...new Set(notes)];
              female.push({ name, notes, gender: 'ì—¬' });
            }
          } else if (parts[i] === 'ë‚¨' && parts[i + 1]) {
            let name = parts[i + 1];
            
            // ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë¦„ í•„í„°ë§
            if (isValidName(name)) {
              let notes = [];
              
              for (let j = i + 2; j < i + 7 && j < parts.length; j++) {
                if (parts[j] === 'ë‚¨' || parts[j] === 'ì—¬') break;
                if (parts[j] && !parts[j].match(/^\d+$/)) {
                  const note = parts[j].toLowerCase();
                  // ìœ ì—°í•œ í‚¤ì›Œë“œ ë§¤ì¹­
                  if (note.includes('ìƒí™œ') || note.includes('ì§€ë„')) {
                    notes.push('ìƒí™œì§€ë„');
                  } else if (note.includes('íŠ¹ìˆ˜') || note.includes('ì¥ì• ')) {
                    notes.push('íŠ¹ìˆ˜');
                  } else if (note.includes('í•™ìŠµ') || note.includes('ê¸°ì´ˆ') || note.includes('í•™ë ¥')) {
                    notes.push('í•™ìŠµë¶€ì§„');
                  } else if (note.includes('ë‹¤ë¬¸í™”')) {
                    notes.push('ë‹¤ë¬¸í™”');
                  } else if (note.includes('ì „í•™') || note.includes('ì „ì¶œ')) {
                    notes.push('ì „ì¶œì˜ˆì •');
                  }
                }
              }

              // ì¤‘ë³µ ì œê±°
              notes = [...new Set(notes)];
              male.push({ name, notes, gender: 'ë‚¨' });
            }
          }
        }
      }

      return { female, male };
    }

    // ìœ íš¨í•œ ì´ë¦„ì¸ì§€ í™•ì¸
    function isValidName(name) {
      // ë¹ˆ ë¬¸ìì—´
      if (!name || name.trim() === '') return false;
      
      // ìˆ«ìë§Œ ìˆëŠ” ê²½ìš°
      if (/^\d+$/.test(name)) return false;
      
      // 'ë‚¨', 'ì—¬' ë‹¨ë…
      if (name === 'ë‚¨' || name === 'ì—¬') return false;
      
      // 'ì„±ë³„', 'ì´ë¦„', 'ë¹„ê³ ', 'ìˆœì„œ' ë“± í—¤ë”ë¡œ ë³´ì´ëŠ” ë‹¨ì–´
      const invalidWords = ['ì„±ë³„', 'ì´ë¦„', 'ë¹„ê³ ', 'ìˆœì„œ', 'ë²ˆí˜¸', 'í•™ìƒ', 'ëª…ë‹¨', 'ëª…ë ¬í‘œ'];
      if (invalidWords.includes(name)) return false;
      
      // 1ê¸€ìì´ê³  ìˆ«ìë‚˜ íŠ¹ìˆ˜ë¬¸ìì¸ ê²½ìš°
      if (name.length === 1 && !/[ê°€-í£a-zA-Z]/.test(name)) return false;
      
      // í•œê¸€, ì˜ë¬¸ì´ í•˜ë‚˜ë„ ì—†ëŠ” ê²½ìš°
      if (!/[ê°€-í£a-zA-Z]/.test(name)) return false;
      
      return true;
    }

    function getPrefixes(notes) {
      let prefixes = '';
      
      if (notes.includes('ìƒí™œì§€ë„')) prefixes += 'â­';
      if (notes.includes('íŠ¹ìˆ˜')) prefixes += '#';
      if (notes.includes('í•™ìŠµë¶€ì§„')) prefixes += 'â—';
      if (notes.includes('ë‹¤ë¬¸í™”')) prefixes += '@';
      if (notes.includes('ì „ì¶œì˜ˆì •')) prefixes += 'ğŸ”„';
      
      return prefixes;
    }

    function hasSpecialNote(notes) {
      return notes.includes('ìƒí™œì§€ë„') || notes.includes('íŠ¹ìˆ˜') || 
             notes.includes('í•™ìŠµë¶€ì§„') || notes.includes('ë‹¤ë¬¸í™”');
    }

    function isTransfer(notes) {
      return notes.includes('ì „ì¶œì˜ˆì •');
    }

    function distributeStudentsWithBalance(students, classNumber) {
      const totalClasses = settings.totalClasses;
      const femaleStart = (classNumber - 1) % totalClasses;
      const maleStart = (classNumber - 1 + Math.floor(totalClasses / 2)) % totalClasses;

      // 1ë‹¨ê³„: í•™ìƒ ë¶„ë¥˜
      const femaleNormal = students.female.filter(s => !hasSpecialNote(s.notes) && !isTransfer(s.notes));
      const femaleSpecial = students.female.filter(s => hasSpecialNote(s.notes) && !isTransfer(s.notes));
      const femaleTransfer = students.female.filter(s => isTransfer(s.notes));

      const maleNormal = students.male.filter(s => !hasSpecialNote(s.notes) && !isTransfer(s.notes));
      const maleSpecial = students.male.filter(s => hasSpecialNote(s.notes) && !isTransfer(s.notes));
      const maleTransfer = students.male.filter(s => isTransfer(s.notes));

      // 2ë‹¨ê³„: ì¼ë°˜ í•™ìƒ ë°°ì¹˜
      femaleNormal.forEach((student, i) => {
        const classIndex = (femaleStart + i) % totalClasses;
        const className = classNames[classIndex] + '(ì—¬)';
        addStudent(className, student, classNumber);
      });

      maleNormal.forEach((student, i) => {
        const classIndex = (maleStart + i) % totalClasses;
        const className = classNames[classIndex] + '(ë‚¨)';
        addStudent(className, student, classNumber);
      });

      // 3ë‹¨ê³„: íŠ¹ìˆ˜ìƒí™© í•™ìƒ ê· ë“± ë°°ì¹˜
      femaleSpecial.forEach((student, i) => {
        const classIndex = (femaleStart + femaleNormal.length + i) % totalClasses;
        const className = classNames[classIndex] + '(ì—¬)';
        addStudent(className, student, classNumber);
      });

      maleSpecial.forEach((student, i) => {
        const classIndex = (maleStart + maleNormal.length + i) % totalClasses;
        const className = classNames[classIndex] + '(ë‚¨)';
        addStudent(className, student, classNumber);
      });

      // 4ë‹¨ê³„: ì „ì¶œì˜ˆì • í•™ìƒì€ ì„ì‹œ ì €ì¥ (ë§ˆì§€ë§‰ì— ë°°ì¹˜)
      femaleTransfer.forEach((student) => {
        const className = 'temp_female_transfer';
        if (!distributedStudents[className]) distributedStudents[className] = [];
        addStudent(className, student, classNumber);
      });

      maleTransfer.forEach((student) => {
        const className = 'temp_male_transfer';
        if (!distributedStudents[className]) distributedStudents[className] = [];
        addStudent(className, student, classNumber);
      });

      // 5ë‹¨ê³„: ì¸ì› ê· ë“±í™” (ëª¨ë“  ë°˜ ì—…ë¡œë“œ ì™„ë£Œ í›„ ì‹¤í–‰)
      balanceClassSizes();
    }

    function balanceClassSizes() {
      // ì „ì¶œì˜ˆì • í•™ìƒ ì œì™¸í•˜ê³  í˜„ì¬ ì¸ì› ê³„ì‚°
      const femaleCount = {};
      const maleCount = {};

      for (let i = 0; i < settings.totalClasses; i++) {
        const className = classNames[i];
        femaleCount[className] = (distributedStudents[className + '(ì—¬)'] || []).length;
        maleCount[className] = (distributedStudents[className + '(ë‚¨)'] || []).length;
      }

      // ëª©í‘œ ì¸ì› ê³„ì‚°
      const totalFemale = Object.values(femaleCount).reduce((a, b) => a + b, 0);
      const totalMale = Object.values(maleCount).reduce((a, b) => a + b, 0);
      const targetFemale = Math.ceil(totalFemale / settings.totalClasses);
      const targetMale = Math.ceil(totalMale / settings.totalClasses);

      // ì—¬í•™ìƒ ê· ë“±í™”
      balanceGender('ì—¬', femaleCount, targetFemale);

      // ë‚¨í•™ìƒ ê· ë“±í™”
      balanceGender('ë‚¨', maleCount, targetMale);

      // ì „ì¶œì˜ˆì • í•™ìƒ ë§ˆì§€ë§‰ì— ì¶”ê°€
      addTransferStudentsToEnd();
    }

    function balanceGender(gender, counts, target) {
      const genderKey = '(' + gender + ')';
      let iterations = 0;
      const maxIterations = 100;

      while (iterations < maxIterations) {
        let balanced = true;
        
        for (let i = 0; i < settings.totalClasses; i++) {
          const fromClass = classNames[i] + genderKey;
          const currentCount = (distributedStudents[fromClass] || []).length;

          if (currentCount > target) {
            // ì¸ì›ì´ ë§ì€ ë°˜ì—ì„œ ì´ë™
            for (let j = 0; j < settings.totalClasses; j++) {
              const toClass = classNames[j] + genderKey;
              const toCount = (distributedStudents[toClass] || []).length;

              if (toCount < target && currentCount > target) {
                // ì „ì¶œì˜ˆì •ì´ ì•„ë‹Œ í•™ìƒ ì¤‘ ë§ˆì§€ë§‰ í•™ìƒ ì´ë™
                const students = distributedStudents[fromClass];
                const nonTransferStudents = students.filter(s => !isTransfer(s.notes));
                
                if (nonTransferStudents.length > 0) {
                  const studentToMove = nonTransferStudents[nonTransferStudents.length - 1];
                  distributedStudents[fromClass] = students.filter(s => s.name !== studentToMove.name);
                  distributedStudents[toClass].push(studentToMove);
                  balanced = false;
                  break;
                }
              }
            }
          }
        }

        if (balanced) break;
        iterations++;
      }
    }

    function addTransferStudentsToEnd() {
      // ì—¬í•™ìƒ ì „ì¶œì˜ˆì •
      const femaleTransfer = distributedStudents['temp_female_transfer'] || [];
      femaleTransfer.forEach((student, i) => {
        const classIndex = i % settings.totalClasses;
        const className = classNames[classIndex] + '(ì—¬)';
        distributedStudents[className].push(student);
      });
      delete distributedStudents['temp_female_transfer'];

      // ë‚¨í•™ìƒ ì „ì¶œì˜ˆì •
      const maleTransfer = distributedStudents['temp_male_transfer'] || [];
      maleTransfer.forEach((student, i) => {
        const classIndex = i % settings.totalClasses;
        const className = classNames[classIndex] + '(ë‚¨)';
        distributedStudents[className].push(student);
      });
      delete distributedStudents['temp_male_transfer'];
    }

    function addStudent(className, student, classNumber) {
      const prefixes = getPrefixes(student.notes);
      const studentData = {
        name: student.name,
        notes: student.notes,
        displayName: prefixes + student.name,
        gender: student.gender,
        originalClass: classNumber
      };
      
      distributedStudents[className].push(studentData);
    }

    function renderResult() {
      const grid = document.getElementById('resultGrid');
      grid.innerHTML = '';

      for (let i = 0; i < settings.totalClasses; i++) {
        const classSection = createClassSection(classNames[i]);
        grid.appendChild(classSection);
      }
    }

    function createClassSection(className) {
      const section = document.createElement('div');
      section.className = 'class-section';

      const femaleStudents = distributedStudents[className + '(ì—¬)'] || [];
      const maleStudents = distributedStudents[className + '(ë‚¨)'] || [];
      const totalCount = femaleStudents.length + maleStudents.length;

      // íŠ¹ì´ì‚¬í•­ í†µê³„
      const stats = getClassStats(femaleStudents, maleStudents);

      // ë©”ì¸ í—¤ë”
      const mainHeader = document.createElement('div');
      mainHeader.className = 'class-main-header';
      mainHeader.textContent = `${className} (${totalCount}ëª…)`;
      section.appendChild(mainHeader);

      // í†µê³„
      if (stats.length > 0) {
        const statsDiv = document.createElement('div');
        statsDiv.className = 'class-stats';
        statsDiv.textContent = 'ğŸ“Š ' + stats.join(' / ');
        section.appendChild(statsDiv);
      }

      // ë‚¨ë…€ ì»¬ëŸ¼
      const columns = document.createElement('div');
      columns.className = 'class-columns';

      const femaleCol = createGenderColumn(className + '(ì—¬)', 'ì—¬', femaleStudents);
      const maleCol = createGenderColumn(className + '(ë‚¨)', 'ë‚¨', maleStudents);

      columns.appendChild(femaleCol);
      columns.appendChild(maleCol);
      section.appendChild(columns);

      return section;
    }

    function getClassStats(femaleStudents, maleStudents) {
      const allStudents = [...femaleStudents, ...maleStudents];
      const stats = {
        'ìƒí™œì§€ë„': 0,
        'íŠ¹ìˆ˜': 0,
        'í•™ìŠµë¶€ì§„': 0,
        'ë‹¤ë¬¸í™”': 0,
        'ì „ì¶œì˜ˆì •': 0
      };

      allStudents.forEach(student => {
        student.notes.forEach(note => {
          if (stats.hasOwnProperty(note)) {
            stats[note]++;
          }
        });
      });

      const result = [];
      for (let key in stats) {
        if (stats[key] > 0 && key !== 'ì „ì¶œì˜ˆì •') {
          result.push(`${key} ${stats[key]}ëª…`);
        }
      }
      if (stats['ì „ì¶œì˜ˆì •'] > 0) {
        result.push(`ì „ì¶œì˜ˆì • ${stats['ì „ì¶œì˜ˆì •']}ëª…`);
      }

      return result;
    }

    function createGenderColumn(className, genderLabel, students) {
      const col = document.createElement('div');
      col.className = 'class-column';
      col.style.background = genderLabel === 'ì—¬' ? '#FFF0F0' : '#F0F8FF';

      const subHeader = document.createElement('div');
      subHeader.className = 'class-sub-header';
      subHeader.textContent = `${genderLabel} (${students.length}ëª…)`;
      col.appendChild(subHeader);

      col.ondragover = (e) => e.preventDefault();
      col.ondrop = (e) => {
        e.preventDefault();
        if (draggedStudent && draggedFrom !== className) {
          distributedStudents[draggedFrom] = distributedStudents[draggedFrom].filter(s => s.name !== draggedStudent.name);
          distributedStudents[className].push(draggedStudent);
          autoSave();
          renderResult();
        }
      };

      // ì •ë ¬: ì¼ë°˜ í•™ìƒ â†’ íŠ¹ìˆ˜ìƒí™© í•™ìƒ â†’ ì „ì¶œì˜ˆì • í•™ìƒ
      const sortedStudents = [...students].sort((a, b) => {
        const aTransfer = isTransfer(a.notes);
        const bTransfer = isTransfer(b.notes);
        const aSpecial = hasSpecialNote(a.notes);
        const bSpecial = hasSpecialNote(b.notes);
        
        // ì „ì¶œì˜ˆì •ì€ ë§¨ ë’¤
        if (aTransfer && !bTransfer) return 1;
        if (!aTransfer && bTransfer) return -1;
        
        // íŠ¹ìˆ˜ìƒí™©ì€ ì¤‘ê°„
        if (aSpecial && !bSpecial && !aTransfer) return 1;
        if (!aSpecial && bSpecial && !bTransfer) return -1;
        
        return 0;
      });

      sortedStudents.forEach(student => {
        const card = document.createElement('div');
        card.className = 'student-card ' + (genderLabel === 'ì—¬' ? 'female' : 'male');
        card.draggable = true;
        card.style.position = 'relative';
        card.innerHTML = `
          <button class="delete-btn" onclick="deleteStudent('${className}', '${student.name}'); event.stopPropagation();" title="í•™ìƒ ì‚­ì œ">Ã—</button>
          <div style="font-weight: bold; font-size: 14px;">${student.displayName}</div>
          ${student.notes && student.notes.length > 0 ? `<div style="font-size: 11px; color: #666; margin-top: 5px;">${student.notes.join(', ')}</div>` : ''}
        `;

        card.ondragstart = () => {
          draggedStudent = student;
          draggedFrom = className;
          card.classList.add('dragging');
        };

        card.ondragend = () => {
          card.classList.remove('dragging');
        };

        col.appendChild(card);
      });

      return col;
    }

    function deleteStudent(className, studentName) {
      if (confirm(`${studentName.replace(/^[â­#â—@ğŸ”„]+/, '')} í•™ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        distributedStudents[className] = distributedStudents[className].filter(s => s.name !== studentName);
        autoSave();
        renderResult();
        showMessage('resultMessage', 'í•™ìƒì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
      }
    }

    function downloadExcel() {
      try {
        const workbook = XLSX.utils.book_new();

        for (let i = 0; i < settings.totalClasses; i++) {
          const className = classNames[i];
          const femaleStudents = distributedStudents[className + '(ì—¬)'] || [];
          const maleStudents = distributedStudents[className + '(ë‚¨)'] || [];

          // ì„±ë³„ë¡œ ì •ë ¬: ì „ì¶œì˜ˆì •ì€ ë§¨ ë’¤, ë‚˜ë¨¸ì§€ëŠ” ê°€ë‚˜ë‹¤ìˆœ
          const sortedFemale = sortForExcel(femaleStudents);
          const sortedMale = sortForExcel(maleStudents);

          const sheetData = [
            ['ì´ë¦„', 'ì„±ë³„', 'ë¹„ê³ ']
          ];

          sortedFemale.forEach(s => {
            const cleanName = s.name.replace(/^[â­#â—@ğŸ”„]+/, '');
            sheetData.push([cleanName, 'ì—¬', s.notes ? s.notes.join(', ') : '']);
          });

          sortedMale.forEach(s => {
            const cleanName = s.name.replace(/^[â­#â—@ğŸ”„]+/, '');
            sheetData.push([cleanName, 'ë‚¨', s.notes ? s.notes.join(', ') : '']);
          });

          const worksheet = XLSX.utils.aoa_to_sheet(sheetData);
          
          worksheet['!cols'] = [
            { wch: 12 },
            { wch: 6 },
            { wch: 20 }
          ];

          XLSX.utils.book_append_sheet(workbook, worksheet, className);
        }

        const fileName = `${settings.schoolName}_${settings.grade}í•™ë…„_ë°˜ë°°ì¹˜ê²°ê³¼.xlsx`;
        XLSX.writeFile(workbook, fileName);

        showMessage('resultMessage', 'ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
      } catch (error) {
        console.error('ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
        showMessage('resultMessage', 'ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ' + error.message, 'error');
      }
    }

    function sortForExcel(students) {
      // ì „ì¶œì˜ˆì • í•™ìƒê³¼ ì¼ë°˜ í•™ìƒ ë¶„ë¦¬
      const transferStudents = students.filter(s => isTransfer(s.notes));
      const normalStudents = students.filter(s => !isTransfer(s.notes));

      // ì¼ë°˜ í•™ìƒì€ ê°€ë‚˜ë‹¤ìˆœ ì •ë ¬
      normalStudents.sort((a, b) => {
        const nameA = a.name.replace(/^[â­#â—@ğŸ”„]+/, '');
        const nameB = b.name.replace(/^[â­#â—@ğŸ”„]+/, '');
        return nameA.localeCompare(nameB, 'ko-KR');
      });

      // ì „ì¶œì˜ˆì • í•™ìƒë„ ê°€ë‚˜ë‹¤ìˆœ ì •ë ¬
      transferStudents.sort((a, b) => {
        const nameA = a.name.replace(/^[â­#â—@ğŸ”„]+/, '');
        const nameB = b.name.replace(/^[â­#â—@ğŸ”„]+/, '');
        return nameA.localeCompare(nameB, 'ko-KR');
      });

      // ì¼ë°˜ í•™ìƒ + ì „ì¶œì˜ˆì • í•™ìƒ ìˆœì„œë¡œ ë°˜í™˜
      return [...normalStudents, ...transferStudents];
    }

    function resetAll() {
      if (confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        distributedStudents = {};
        uploadedClasses = {};
        clearAutoSave();
        showPage(1);
        document.getElementById('schoolName').value = '';
        document.getElementById('grade').value = '';
      }
    }

    function showMessage(elementId, message, type) {
      const msgDiv = document.getElementById(elementId);
      msgDiv.textContent = message;
      msgDiv.className = 'message ' + type;
      msgDiv.style.display = 'block';

      setTimeout(() => {
        msgDiv.style.display = 'none';
      }, 5000);
    }
  </script>
</body>
</html>
